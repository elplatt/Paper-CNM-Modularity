\documentclass{article}

\newcommand{\beq}{\begin{eqnarray}}
\newcommand{\eeq}{\end{eqnarray}}

\begin{document}

The Clauset-Newman-Moore (CNM) community detection algorithm \cite{clauset_finding_2004}
greedily maximizes the {\em modularity} $Q$ by repeatedly merging smaller communities.
The orginal presentation is given for an unweighted, undirected network with no self-loops.
This paper derives analogoous equations for weighted networks with self-loops,
both directed and undirected.

Throughout this paper, $A_{vw}$ refers to an entry in the adjacency matrix of a network.
Each {\em edge} connects two {\em vertices},
which can be the same vertex for both edges (in the case of a self-loop).
A {\em stub} is one half of an edge, and is associated with single vertex.
Each edge has a {\em weight}, with $m$ refering to the total edge weight.
In an {\em undirected} network, edges are symmetric with respect to vertices.
In a {\em directed} network, the edge is outgoing from the {\em source} vertex
and incident upon the {\em target} vertex.
Respectively, the degree $k_v$, in-degree $k_v^{(in)}$, and out-degree $k_v^{(out)}$ refer to the
sum of adjacent edge weights, sum of incident edge weights, and sum of outgoing edge weights.
The term $\delta_{ij}$ is equal to 1 if $i = j$ and 0 otherwise.

\section{Undirected}
In an undirected network, modularity is defined as:
\beq
\label{eq:modularity} Q &=& \frac{1}{2m} \sum_{vw} \left[ A_{vw} (1 + \delta_{vw}) - \frac{k_v k_w}{2m} \right]\delta_{c_v c_w} \\
m &=& \frac{1}{2} \sum_{vw} A_{vw} (1 + \delta_{vw}),
\eeq
where $m$ is the total number of edges is the network and $c_v$ is the community containing vertex $v$.
Equation \ref{eq:modularity} differs from \cite{clauset_finding_2004} by the inclusion of a $\delta_{vw}$ term.
This term is necessary when self-loops are present,
because unlike off-diagonal entries, each diagonal entry represents two stubs.

The degree of vertex $v$ is given by:
\beq
k_v &=& \sum_w A_{vw} (1+\delta_{vw}).
\eeq
The fraction of edge weight between communities $i$ and $j$ is given by:
\beq
e_{ij} &=& \frac{1}{2m}\sum_{vw} A_{vw} (1+\delta_{vw}) \delta_{c_vi}\delta_{c_wj}.
\eeq
The fraction of stub weight within community $i$ is given by:
\beq
a_i &=& \frac{1}{2m}\sum_{vw}A_{vw} (1 + \delta_{vw}) \delta_{c_vi} \\
&=& \frac{1}{2m}\sum_v k_v \delta_{c_vi}.
\eeq

Writing the modularity in terms of $e_{ij}$ and $a_i$ by using
$\delta_{c_vc_w} = \delta_{c_vi}\delta{c_wi}$:
\beq
Q &=& \frac{1}{2m} \sum_{ivw} \left[ A_{vw} (1 + \delta_{vw}) - \frac{k_v k_w}{2m} \right]\delta_{c_v i}\delta_{c_w i} \\
&=& \sum_i 
\frac{1}{2m} \sum_{vw} A_{vw} (1 + \delta_{vw}) \delta_{c_v i}\delta_{c_w i}  \nonumber \\
&& - \sum_i  \frac{1}{(2m)^2} \sum_{v} k_v \sum_w k_w \delta_{c_v i}\delta_{c_w i}  \\
&=& \sum_i 
\frac{1}{2m} \sum_{vw} A_{vw} (1 + \delta_{vw}) \delta_{c_v i}\delta_{c_w i}  \nonumber \\
&& - \sum_i  \left( \frac{1}{2m} \sum_{v} k_v \delta_{c_v i} \right) \left(\frac{1}{2m}\sum_w k_w \delta_{c_w i} \right) \\
&=& \sum_i \left( e_{ii} - a_i^2 \right).
\eeq

\begin{thebibliography}{1}
\bibitem{clauset_finding_2004} 
Aaron Clauset, M. E. J. Newman, and Christopher Moore.
\textit{Finding community structure in very large networks}. 
Physical review E 70(6):066111, 2004.
\end{thebibliography}

\end{document}
